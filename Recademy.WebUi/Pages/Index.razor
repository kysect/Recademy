@page "/"
@using Recademy.Core.Dto
@inject ILogger<Counter> Logger
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Index</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

<SurveyPrompt Title="How is Blazor working for you?" />

@if (_user is null)
{
    <button class="btn btn-primary" @onclick="SignIn">Sign in</button>
}
else
{
    <button class="btn btn-primary" @onclick="SignOut">Sign out</button>
    @_user.GithubUsername
}

@code {
    private UserInfoDto? _user;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _user = await Http.GetFromJsonAsync<UserInfoDto>("api/auth/user/current");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"An error occurred while initializing page");
        }
    }

    private async void SignIn()
    {
        NavigationManager.NavigateTo("api/auth/sign-in", forceLoad: true);

        try
        {
            _user = await Http.GetFromJsonAsync<UserInfoDto>("api/auth/github");

        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"An error occurred while signing in user");
        }
    }

    private void SignOut()
    {
        NavigationManager.NavigateTo("api/auth/sign-out", forceLoad: true);
    }
}